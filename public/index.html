export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const email = url.searchParams.get("email");
    const first = url.searchParams.get("first");
    const last = url.searchParams.get("last");

    const API_TOKEN = "oOcGyvGsuhv7ZfvcSo7nJLr5H30UA6Yv";
    const CONTACTS_TABLE_ID = 574979;
    const API_BASE = `https://api.baserow.io/api/database/rows/table/${CONTACTS_TABLE_ID}/`;
    const headers = {
      Authorization: `Token ${API_TOKEN}`,
      "Content-Type": "application/json"
    };

    // Handle CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type"
        }
      });
    }

    if (!email && (!first || !last)) {
      return new Response(JSON.stringify({ error: "Missing search parameters" }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }

    // Field IDs from Baserow (these must be accurate)
    const FIELD_CONTACT_ID = "field_4625764";
    const FIELD_FIRST_NAME = "field_4625765";
    const FIELD_LAST_NAME = "field_4625766";
    const FIELD_PHONE = "field_4625770";
    const FIELD_EMAIL = "field_4625771";

    // Construct filter params
    let filterParams = "";
    if (email) {
      filterParams = `?filter__${FIELD_EMAIL}=${encodeURIComponent(email.toLowerCase())}`;
    } else {
      filterParams = `?filter__${FIELD_FIRST_NAME}=${encodeURIComponent(first)}&filter__${FIELD_LAST_NAME}=${encodeURIComponent(last)}`;
    }

    const fullUrl = `${API_BASE}${filterParams}`;
    const res = await fetch(fullUrl, { headers });
    const json = await res.json();

    const row = json?.result || json?.results?.[0];

    if (!row) {
      return new Response(JSON.stringify({
        success: true,
        email: "N/A",
        phone: "N/A",
        first_name: "N/A",
        last_name: "N/A",
        contact_id: "N/A",
        debug: { full_url: fullUrl, raw_count: json?.count ?? 0, source: "not found" }
      }), {
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type",
          "Content-Type": "application/json"
        }
      });
    }

    const mapped = {
      success: true,
      contact_id: row[FIELD_CONTACT_ID] || "N/A",
      first_name: row[FIELD_FIRST_NAME] || "N/A",
      last_name: row[FIELD_LAST_NAME] || "N/A",
      phone: row[FIELD_PHONE] || "N/A",
      email: row[FIELD_EMAIL] || "N/A",
      debug: { full_url: fullUrl, matched_id: row.id }
    };

    return new Response(JSON.stringify(mapped), {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
        "Content-Type": "application/json"
      }
    });
  }
};

