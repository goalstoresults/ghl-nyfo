<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Save Relationship</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #f5f5f5;
    }
    input, select, button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      font-size: 16px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row > div {
      flex: 1;
    }
  </style>
</head>
<body>
  <h2>Test: Save Relationship (Hardcoded Source)</h2>

  <input type="text" id="relatedFirstName" placeholder="Related First Name">
  <input type="text" id="relatedLastName" placeholder="Related Last Name">
  <div style="text-align: center;">— OR —</div>
  <input type="text" id="relatedEmail" placeholder="Related Email">
  <button onclick="searchRelated()">Search Related Contact</button>

  <div id="relatedResult"></div>

  <script>
    const sourceContact = {
      contact_id: "0YJJ6BGThbO75N6cj7Py",
      first_name: "Brad",
      last_name: "Ross"
    };

    let relatedContact = null;

    async function searchRelated() {
      const first = document.getElementById("relatedFirstName").value.trim();
      const last = document.getElementById("relatedLastName").value.trim();
      const email = document.getElementById("relatedEmail").value.trim();

      let url = "https://ghl-nyfo-api.dennis-e64.workers.dev/?";
      if (email) {
        url += "email=" + encodeURIComponent(email);
      } else if (first && last) {
        url += `first=${encodeURIComponent(first)}&last=${encodeURIComponent(last)}`;
      } else {
        alert("Enter related contact's email or first + last name");
        return;
      }

      const res = await fetch(url);
      const data = await res.json();

      const result = document.getElementById("relatedResult");
      result.innerHTML = '';

      if (data?.email === "N/A") {
        result.innerHTML = "<p><strong>Related contact not found</strong></p>";
        return;
      }

      relatedContact = data?.debug?.contactMatch;

      const name = `${relatedContact["First Name"]} ${relatedContact["Last Name"]}`.trim();

      result.innerHTML = `
        <p><strong>Related Contact:</strong> ${name} (${data.email})</p>
        <div class="row">
          <div>
            <label>Relationship Type:</label>
            <select id="relationshipType">
              <option value="">Select type</option>
              <option value="Client- Vendor">Client- Vendor</option>
              <option value="Partner">Partner</option>
              <option value="Family">Family</option>
            </select>
          </div>
          <div>
            <label>Relationship Role:</label>
            <select id="relationshipRole">
              <option value="">Select role</option>
              <option value="Accountant">Accountant</option>
              <option value="Attorney">Attorney</option>
              <option value="Spouse">Spouse</option>
            </select>
          </div>
        </div>
        <button onclick="saveRelationship()">Save Relationship</button>
        <div id="saveResult"></div>
      `;
    }

    async function saveRelationship() {
      const type = document.getElementById("relationshipType").value;
      const role = document.getElementById("relationshipRole").value;
      const resultBox = document.getElementById("saveResult");

      if (!relatedContact || !type || !role) {
        alert("Fill out all fields.");
        return;
      }

      const payload = {
        source_contact_id: sourceContact.contact_id,
        related_contact_id: relatedContact["Contact Id"],
        relationship_type: type,
        relationship_role: role
      };

      const res = await fetch("https://ghl-nyfo-save-relationship.dennis-e64.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      console.log(result);

      if (result.success) {
        resultBox.innerHTML = `<p style="color:green;">✅ Relationship saved!</p>`;
      } else {
        resultBox.innerHTML = `<p style="color:red;">❌ Failed: ${result.error || "Unknown error"}</p>`;
      }
    }
  </script>
</body>
</html>
